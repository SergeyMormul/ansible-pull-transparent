#!/usr/bin/env ansible-playbook

- name: Gather prerequisites 
  hosts: all
  gather_facts: True
  tasks:
    - group_by: key={{ ansible_distribution }}

- name: Install Pakcages (Ubuntu)
  hosts: Ubuntu
  become: False
  tasks:
    - apt: name=git state=present

- name: Install Git Projects
  hosts: all
  become: False
  tasks:
    - file: path=/home/vagrant/bin state=directory mode=0755
    - git: repo=https://github.com/kurron/docker-compose-tl.git dest=/home/vagrant/bin/servers
    - file: path=/home/vagrant owner=vagrant group=vagrant recurse=true state=directory

- name: Docker Registry (must be on VPN)
  hosts: all
  become: True
  tasks:
      - name: Create CA certificates directory
        file: path=/usr/local/share/ca-certificates/docker-registry state=directory
      - name: Create SSL certificates directory
        file: path=/etc/ssl/certs/ state=directory
      - name: Create SSL certificates directory
        get_url: >
                url=http://192.168.254.81:81/artifactory/static/ease/docker-registry/certifcate/registry.transparent.CA.crt
                dest=/usr/local/share/ca-certificates/docker-registry/registry.transparent.CA.crt
        register: certificate
#     - name: Add registry to hosts file
#       lineinfile: dest=/etc/hosts line="192.168.254.90 registry.transparent.com"
#     - name: Add cd1 to hosts file
#       lineinfile: dest=/etc/hosts line="192.168.254.81 cd1"
      - name: Update certificates
        shell: update-ca-certificates
        when: certificate|changed
      - name: Place configuration file into the root account
        get_url: url=http://192.168.254.81:81/artifactory/static/ease/docker-registry/.dockercfg dest=/root/.dockercfg
      - name: Place configuration file into the vagrant account
        get_url: url=http://192.168.254.81:81/artifactory/static/ease/docker-registry/.dockercfg dest=/home/vagrant/.dockercfg
      - name: Restart Docker
        command: service docker restart
        when: certificate|changed
      - name: Set permissions on the home directory
        file: path=/home/vagrant owner=vagrant group=vagrant recurse=true state=directory

- name: Install FFMpeg
  hosts: all
  become: True
  tasks:
      - get_url: url= http://192.168.254.81:81/artifactory/static/ffmpeg/ffmpeg-2.6.1-64bit-static.tar.xz dest=/root/ffmpeg.tar.xz
      - unarchive: src=/root/ffmpeg.tar.xz dest=/opt copy=no owner=root group=root mode=555 creates=/opt/ffmpeg-2.6.1-64bit-static/ffprobe
      - file: src=/opt/ffmpeg-2.6.1-64bit-static path=/opt/ffmpeg state=link

- name: Create Source Folders 
  hosts: all
  become: False
  tasks:
      - file: path=/home/vagrant/Bitbucket/Asgard state=directory
      - file: path=/home/vagrant/Bitbucket/Gradle state=directory
      - file: path=/home/vagrant/Bitbucket/Mold-E state=directory
      - file: path=/home/vagrant/Bitbucket/Sush-E state=directory
      - file: path=/home/vagrant/Bitbucket/Operations state=directory
      - file: path=/home/vagrant/Bitbucket/Asgard-Light state=directory
      - file: path=/home/vagrant owner=vagrant group=vagrant recurse=true state=directory

- name: Update Hosts File
  hosts: all
  become: True
  tasks:
      - lineinfile: dest=/etc/hosts line="192.168.100.134 lds"
      - lineinfile: dest=/etc/hosts line="192.168.254.123 logfaces"
      - lineinfile: dest=/etc/hosts line="192.168.100.124 logfaces-boston"
      - lineinfile: dest=/etc/hosts line="192.168.254.73 mli-forever"
      - lineinfile: dest=/etc/hosts line="192.168.254.57 mongo1test"
      - lineinfile: dest=/etc/hosts line="192.168.254.63 mongo2test"
      - lineinfile: dest=/etc/hosts line="192.168.254.59 mongo3test" state=absent
      - lineinfile: dest=/etc/hosts line="192.168.100.127 mongo1"
      - lineinfile: dest=/etc/hosts line="192.168.100.183 mongo2"
      - lineinfile: dest=/etc/hosts line="192.168.255.29 stagetwo"
      - lineinfile: dest=/etc/hosts line="192.168.254.85 cd0"
      - lineinfile: dest=/etc/hosts line="192.168.254.81 cd1"
      - lineinfile: dest=/etc/hosts line="192.168.254.114 cd5"
      - lineinfile: dest=/etc/hosts line="192.168.254.59 cd6"
      - lineinfile: dest=/etc/hosts line="192.168.254.28 rabbit-test"
      - lineinfile: dest=/etc/hosts line="192.168.254.58 docker1test"
      - lineinfile: dest=/etc/hosts line="192.168.255.18 al-autotest-integration"
      - lineinfile: dest=/etc/hosts line="192.168.255.16 al-autotest-edge"
